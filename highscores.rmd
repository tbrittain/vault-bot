---
title: Vaultbot Current Highscores
output:
  html_document:
    theme: darkly
    highlight: pygments
    self_contained: true
fig_width: 10
fig_height: 4
---

<style>

@import url("https://fonts.googleapis.com/css?family=Rubik");
@import url("https://fonts.googleapis.com/css?family=Monofett");

* {
    font-family: Rubik, Arial, Helvetica, sans-serif;
}

::-moz-selection {
    background-color: #0CE3AC;
    color: black;
}

::selection {
    background-color: #0CE3AC;
    color: black;
}

html{
    min-height: 100%;
    scroll-behavior: smooth;
    overflow: auto;
}

body .main-container {
    max-width: 4000px;
}

body {
    background-image: url('artist_images/background2.jpg'), linear-gradient(to right, hsla(165, 40%, 47%, 1) 0%, hsla(103, 40%, 71%, 1) 50%, hsla(165, 40%, 47%, 1) 100%);
    background-blend-mode: overlay;
    background-repeat: repeat;
    font-size: 16px;
    line-height: 24px;
    overflow: auto;
}

div {
  text-align: center;
}

h1,h2,h3,h4 {
    background-color: rgba(0, 0, 0, 0.75);
    font-weight: bold;
    font-size: 4rem;
    width: max-content;
    padding: 10px 10px;
    border-radius: 15px;
    margin: auto;
}

p {
    background-color: rgba(0, 0, 0, 0.75);
    margin: auto auto 10.5px;
    width: max-content;
    padding: 10px 10px;
    border-radius: 15px;
}

.container {
    width: 1000px;
}

.tbl {
    margin-left: auto;
    margin-right: auto;
}

h3 {
  background-color: #D4DAEC;
  text-indent: 100px;
}

h4 {
  text-indent: 100px;
}

.center {
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 40%;
}

.centersmall {
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 12%;
}

.bar-sort-header:hover {
  background-color: #373845;
}

/*Navigation bar CSS*/

.sidenav {
  height: 100%;
  width: 0;
  position: fixed;
  z-index: 100;
  top: 0;
  left: 0;
  background-color: rgb(17, 17, 17);
  overflow-x: hidden;
  text-overflow: clip;
  white-space: nowrap; 
  transition: 0.5s;
  padding-top: 60px;
  text-align: left;
}

.sidenav a {
  font-family: Rubik, Arial, Helvetica, sans-serif;
  padding: 15px 32px 15px 32px;
  text-decoration: none;
  font-size: 25px;
  color: #818181;
  display: block;
  transition: 0.3s;
}

.sidenav a:hover {
  color:#0CE3AC;
}

.sidenav .closebtn {
  position: absolute;
  padding: 10px 10px;
  top: 0;
  right: 0;
  font-size: 40px;
}

@media screen and (max-height: 450px) {
  .sidenav {padding-top: 15px;}
  .sidenav a {font-size: 18px;}
}

.openbtn {
    font-size: 30px;
    cursor: pointer;
    color: white;
    position: fixed;
    left: 0;
    background-color:  #0ce3ad;
    text-shadow: 0px 0px 5px #000;
    padding: 15px 15px;
    border-radius: 100%;
    box-shadow: 0px 0px 10px #000;
    border: 2px solid black;
    left: 0;
    top: 0;
    margin: 20px 20px;
}

hr {
    border: 1px solid #0CE3AC;
}

#active {
  background-color: #0CE3AC;
  color: #111;
  transition: 0.3s;
}

#active:hover {
    color: #FFF;
}

#homepage {
    position: absolute;
    bottom: 10px;
}

.title {
    visibility: hidden;
}

/*Vaultbot title*/

.vaultbot-title {
    font-family: Monofett, sans-serif;
    background-color: transparent;
    font-size: 8vw;
    max-width: 65%;
    text-align: center;
    margin: auto auto;
    overflow: hidden;
    text-overflow: ellipsis;
    word-wrap: normal;
    display: block;
}

.gradient-text {
    background-color: #0CE3AC;
    background-image: linear-gradient(45deg, hsla(165, 90%, 47%, 1) 0%, hsla(103, 100%, 71%, 1) 50%, hsla(165, 90%, 47%, 1) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -moz-background-clip: text;

    text-fill-color: transparent;
    -webkit-text-fill-color: transparent;
    -moz-text-fill-color: transparent;

    transition: 0.2s ease-in-out;
    -moz-transition: 0.2s ease-in-out;
    -webkit-transition: 0.2s ease-in-out;
    animation: hoveranimation 5s linear infinite;
}


@keyframes hoveranimation {
	to {
		background-position: 200% center;
	}
}

.noselect {
  -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Old versions of Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome, Edge, Opera and Firefox */


</style>

```{r setup, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
library(rmarkdown)
library(reactable)
library(tibble)
library(htmltools)
library(dplyr)
library(RPostgres)
library(DBI)

# TODO: create new date column with only day dates
```


```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
setwd("D:/Github/vault-bot/")
Sys.setenv(RSTUDIO_PANDOC="C:/Users/Trey/AppData/Local/Pandoc")
readRenviron(".env")
db_user <- Sys.getenv("DB_USER")
db_pass <- Sys.getenv("DB_PASS")
db <- 'vaultbot'
db_port <- 5432
db_host <- 'localhost'

con<-RPostgres::dbConnect(RPostgres::Postgres(), dbname=db, host=db_host, port=db_port, user=db_user, password=db_pass)

total_df <- RPostgres::dbReadTable(con, "dyn_artists")

# disconnect from db
RPostgres::dbDisconnect(con)

# variables for use in title
title_today <- format(Sys.time(), "%c")
song_count <- nrow(total_df)
plot_title <- sprintf("Takes into account %d songs as of %s. Updates every hour!",
                      song_count, title_today)

# bar chart function for use in reactable colDef function
bar_chart <- function(label, width = "100%", height = "16px", fill = "#00bfc4", background = NULL) {
  bar <- htmltools::div(style = list(background = fill, width = width, height = height))
  chart <- htmltools::div(style = list(flexGrow = 1, marginLeft = "8px", background = background), bar)
  htmltools::div(style = list(display = "flex", alignItems = "center"), label, chart)
}
# tooltip function
with_tooltip <- function(value, tooltip) {
  tags$abbr(style = "text-decoration: underline; text-decoration-style: dotted; cursor: help",
            title = tooltip, value)
}

options(reactable.theme = reactableTheme(
  color = "hsl(233, 9%, 87%)",
  backgroundColor = "hsl(233, 9%, 10%)",
  borderColor = "hsl(233, 9%, 0%)",
  stripedColor = "hsl(233, 12%, 13%)",
  highlightColor = "hsl(233, 12%, 24%)",
  inputStyle = list(backgroundColor = "hsl(233, 9%, 12%)"),
  selectStyle = list(backgroundColor = "hsl(233, 9%, 25%)"),
  pageButtonHoverStyle = list(backgroundColor = "hsl(233, 9%, 25%)"),
  pageButtonActiveStyle = list(backgroundColor = "hsl(233, 9%, 28%)"),
  searchInputStyle = list(width = "100%")
))

names(total_df)[1] <- "SongID"
names(total_df)[2] <- "Song"
names(total_df)[3] <- "ArtistID"
names(total_df)[4] <- "Artist"
names(total_df)[5] <- "User"
names(total_df)[6] <- "Genres"

# load genre_df here to calculate some stats for the description of the table
genre_df <- read.csv("genre_output.csv")
# TODO: song as hyperlink to song, same with artist, check out reactable examples (especially the wikipedia example)
# leaving out artist_id column for later
genre_df <- genre_df[, c("Genre", "Artist", "Song", "SongID")]
avg_genres <- length(unique(genre_df$Genre)) / length(unique(genre_df$Artist))
avg_genres <- round(avg_genres, 2)
```
<div id="mySidenav" class="sidenav">
<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
<a href="about.html">About</a>
<hr>
<a href="index.html" id="active">Stats</a>
<a href="advanced.html">Advanced Stats</a>
<a href="highscores.html">Highscores</a>
<hr>
<a href="spotify:playlist:5YQHb5wt9d0hmShWNxjsTs">Dynamic Playlist</a>
<a href="spotify:playlist:4C6pU7YmbBUG8sFFk4eSXj">Archive Playlist</a>
<a id="homepage" href="https://tbrittain.com">Trey's homepage</a>
</div>

<span class="openbtn" onclick="openNav()">&#9776;</span>

<h1 class="vaultbot-title noselect gradient-text">Vaultbot</h1>

Some highscores for different aspects of the dynamic playlist. `r plot_title`

<h2 id="genres"><a href="#genres">Genres</a></h2>
Top Spotify-assigned genres currently in the dynamic playlist. Artists may belong to more than one genre (and some none at all if they are really underground). On average, each artist belongs to `r avg_genres` genres.
For more info on Spotify genres, check out <a href="http://everynoise.com" target=_blank>EveryNoise</a>, or click the link directly to the genre under the GenreLink column.
```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
# it appears that a limitation of the groupBy function of reactable is that you cannot apply
# cell functions to the value, so i unfortunately had to make a separate GenreLink column
# that contains a direct link to the genre in EveryNoise
genre_df$GenreLink <- genre_df$Genre
reactable::reactable(genre_df, groupBy = c("Genre", "Artist"), columns = list(
    Genre = colDef(
        align = "center",
    ),
    GenreLink = colDef(
        align = "left",
        html = TRUE,
        cell = function(value) {
    # Render as a link
    fixed_value <- gsub("&", "", value)
    # God I hate regex patterns. can't get space as " " nor \s to work
    fixed_value <- gsub("-", "", fixed_value)
    fixed_value <- gsub(" ", "", fixed_value)
    url <- sprintf("http://everynoise.com/engenremap-%s.html", fixed_value)
    htmltools::tags$a(href = url, target = "_blank", as.character(value))
    }
    ),
    Artist = colDef(
        aggregate = "count",
        format = list(aggregated = colFormat(suffix = " artists")),
        align = "center",
    ), Song = colDef(
        align = "center",
        aggregate = "unique"

    ), SongID = colDef(
        align = "center",
        cell = function(value) {
                url <- paste0("spotify:track:", value)
                tags$a(href = url, paste0(value))
                },
        header = with_tooltip("ID", "Click to open track in Spotify"),
        style = list(fontFamily = "monospace", whiteSpace = "pre", fontSize = "14px")
    ), GenreLink = colDef(
        align = "center"
    )
), defaultSorted = list(Artist = "desc"),
          wrap = FALSE,
          compact = TRUE,
          bordered = TRUE,
          highlight = TRUE,
          striped = TRUE,
          outlined = TRUE,
          showSortIcon = TRUE,
          defaultPageSize = 20,
          searchable = TRUE,
          style = list(maxWidth = 1500),
          defaultColDef = colDef(headerClass = "bar-sort-header"),
          class = "tbl"
)

# maybe add some plots here
genre_analysis <- aggregate(data.frame(count = genre_df$Genre), list(value = genre_df$Genre), length)
#hist(genre_analysis$count, breaks = 15)
```

<h2 id="artists"><a href="#artists">Artists</a></h2>
Top 25 artists whose songs are currently in the dynamic playlist.
```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
raw_artist_data <- total_df[, c("User", "Artist", "Song")]
artist_counts <- aggregate(data.frame(count = raw_artist_data$Artist), list(value = raw_artist_data$Artist), length)


artist_ids <- total_df[, c("Artist", "ArtistID", "Song")]
artist_ids <- artist_ids[row.names(unique(artist_ids[, c("Artist", "ArtistID")])),]

names(artist_counts)[1] <- "Artist"
names(artist_counts)[2] <- "Songs"

# merge artist_ids with artist_counts
total_artists <- merge(x=artist_counts, y=artist_ids, by="Artist")
artist_counts <- total_artists[, c("Artist", "ArtistID", "Songs")]

artist_counts <- dplyr::arrange(artist_counts, desc(Songs))

reactable(artist_counts[1:25,],
          columns = list(
            Artist = colDef(cell = function(value) {
            image <- img(src = sprintf("artist_images/%s.jpg", value), height = "100px", alt = value)
            tagList(
            div(style = list(display = "inline-block", width = "100px"), image), value)
            }),
            ArtistID = colDef(align = "left",
            style = list(fontFamily = "monospace", whiteSpace = "pre"),
            cell = function(value) {
            url <- paste0("spotify:artist:", value)
            tags$a(href = url, target = "_blank", paste0(value))
            },header = with_tooltip("ID", "Click to open artist in Spotify")),
            Songs = colDef(cell = function(value){
                     width <- paste0(value / max(artist_counts$Songs) * 100, "%")
                     value <- format(value, width = 5, justify = "right")
                     bar_chart(value, width = width,
                               background = "#2b2b2b",
                               fill = "#0CE3AC")},
            style = list(fontFamily = "monospace", whiteSpace = "pre", fontSize = "14px"))),
          highlight = TRUE,
          sortable = FALSE,
          striped = TRUE,
          style = list(maxWidth = 1000),
          outlined = TRUE,
          class = "tbl"
)
```

<h2 id="users"><a href="#users">User Contributions</a></h2>
```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
user_counts <- aggregate(data.frame(count = raw_artist_data$User), list(value = raw_artist_data$User), length)
names(user_counts)[1] <- "User"
names(user_counts)[2] <- "Songs"

user_counts <- dplyr::arrange(user_counts, desc(Songs))

reactable(user_counts,
          columns = list(
            Songs = colDef(cell = function(value){
                     width <- paste0(value / max(user_counts$Songs) * 100, "%")
                     value <- format(value, width = 5, justify = "right")
                     bar_chart(value, width = width,
                               background = "#2b2b2b",
                               fill = "#0CE3AC")},
          style = list(fontFamily = "monospace", whiteSpace = "pre", fontSize = "14px"),
          sortable = FALSE)),
          highlight = TRUE,
          sortable = FALSE,
          outlined = TRUE,
          style = list(maxWidth = 750),
          striped = TRUE,
          class = "tbl"
)
```
Vaultbot is maintained by <a class="navlink" href="https://tbrittain.com" target=_blank>Trey Brittain</a>.

```{js echo=FALSE, results='hide', message=FALSE}
function openNav() {
  document.getElementById("mySidenav").style.width = "250px";
}

function closeNav() {
  document.getElementById("mySidenav").style.width = "0";
}
```
