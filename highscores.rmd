---
title: Vaultbot Current Highscores
output:
  html_document:
    theme: darkly
    highlight: pygments
    self_contained: true
assets:
  css:
    - "https://fonts.googleapis.com/css?family=Rubik"
fig_width: 10
fig_height: 4
---

<style>
html{
    min-height: 100%;
}
body .main-container {
    max-width: 1250px;
}
body {
    background-image: url('artist_images/background1.jpg');
    background-attachment: fixed;
    background-size: cover;
    font-family: 'Rubik', sans-serif;
    font-size: 16px;
    line-height: 24px;
}

div {
  text-align: center;
}

h1,h2,h3,h4 {
    font-family: Arial, Helvetica, sans-serif;
    background-color: rgba(0, 0, 0, 0.5);
    font-weight: bold;
}

p {
    background-color: rgba(0, 0, 0, 0.5);
    font-family: Arial, Helvetica, sans-serif;
}

.container { width: 1000px; }

h3 {
  background-color: #D4DAEC;
  text-indent: 100px;
}

h4 {
  text-indent: 100px;
}

.center {
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 25%;
}

.bar-sort-header:hover {
  background-color: #eee;
}
</style>



```{r setup, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
library(rmarkdown)
library(reactable)
library(tibble)
library(htmltools)
library(dplyr)
library(RPostgres)
library(DBI)

# TODO: create new date column with only day dates
```


```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
setwd("D:/Github/vault-bot/")
Sys.setenv(RSTUDIO_PANDOC="C:/Users/Trey/AppData/Local/Pandoc")
readRenviron(".env")
db_user <- Sys.getenv("DB_USER")
db_pass <- Sys.getenv("DB_PASS")
db <- 'vaultbot'
db_port <- 5432
db_host <- 'localhost'

con<-RPostgres::dbConnect(RPostgres::Postgres(), dbname=db, host=db_host, port=db_port, user=db_user, password=db_pass)

total_df <- RPostgres::dbReadTable(con, "dyn_artists")

# disconnect from db
RPostgres::dbDisconnect(con)

# variables for use in title
title_today <- format(Sys.time(), "%c")
song_count <- nrow(total_df)
plot_title <- sprintf("Takes into account %d songs as of %s. Updates every hour!",
                      song_count, title_today)

# bar chart function for use in reactable colDef function
bar_chart <- function(label, width = "100%", height = "16px", fill = "#00bfc4", background = NULL) {
  bar <- htmltools::div(style = list(background = fill, width = width, height = height))
  chart <- htmltools::div(style = list(flexGrow = 1, marginLeft = "8px", background = background), bar)
  htmltools::div(style = list(display = "flex", alignItems = "center"), label, chart)
}
# tooltip function
with_tooltip <- function(value, tooltip) {
  tags$abbr(style = "text-decoration: underline; text-decoration-style: dotted; cursor: help",
            title = tooltip, value)
}

options(reactable.theme = reactableTheme(
  color = "hsl(233, 9%, 87%)",
  backgroundColor = "hsl(233, 9%, 19%)",
  borderColor = "hsl(233, 9%, 22%)",
  stripedColor = "hsl(233, 12%, 22%)",
  highlightColor = "hsl(233, 12%, 24%)",
  inputStyle = list(backgroundColor = "hsl(233, 9%, 25%)"),
  selectStyle = list(backgroundColor = "hsl(233, 9%, 25%)"),
  pageButtonHoverStyle = list(backgroundColor = "hsl(233, 9%, 25%)"),
  pageButtonActiveStyle = list(backgroundColor = "hsl(233, 9%, 28%)"),
  searchInputStyle = list(width = "100%")
))

names(total_df)[1] <- "SongID"
names(total_df)[2] <- "Song"
names(total_df)[3] <- "ArtistID"
names(total_df)[4] <- "Artist"
names(total_df)[5] <- "User"
names(total_df)[6] <- "Genres"

```


<img src="D:/Github/vault-bot/embeds/vaultbotheader.png" alt="Vaultbot Playlist Song Statistics" class="center">

Some highscores for different aspects of the dynamic playlist. `r plot_title`
To listen to the dynamic playlist, <a class="navlink" href="spotify:playlist:5YQHb5wt9d0hmShWNxjsTs">click here</a>.

To view overall playlist statistics, <a class="navlink" href="http://vaultbot.tbrittain.com/">click here</a>.

## Genres
Top Spotify-assigned genres currently in the dynamic playlist. Artists may belong to more than one genre (and some none at all if they are really underground).
```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
genre_df <- read.csv("genre_output.csv")
reactable::reactable(genre_df,groupBy = c("Genre", "Artist"), columns = list(
    Genre = colDef(
        align = "left"
    ),
    Artist = colDef(
        aggregate = "count",
        format = list(aggregated = colFormat(suffix = " artists")),
        align = "center",
    ), Song = colDef(
        align = "center",
        aggregate = "unique"

    ), SongID = colDef(
        cell = function(value) {
                url <- paste0("spotify:track:", value)
                tags$a(href = url, target = "_blank", paste0(value))
                },
        header = with_tooltip("ID", "Click to open track in Spotify"),
        style = list(fontFamily = "monospace", whiteSpace = "pre", fontSize = "14px")
  )
), defaultSorted = list(Artist = "desc"),
          wrap = FALSE,
          compact = TRUE,
          highlight = TRUE,
          striped = TRUE,
          outlined = TRUE,
          showSortIcon = TRUE,
          defaultPageSize = 20,
          searchable = TRUE,
          defaultColDef = colDef(headerClass = "bar-sort-header"),
)

# maybe add some plots here
genre_analysis <- aggregate(data.frame(count = genre_df$Genre), list(value = genre_df$Genre), length)
#hist(genre_analysis$count, breaks = 15)
```

## Artists
Top 25 artists whose songs are currently in the dynamic playlist.
```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
raw_artist_data <- total_df[, c("User", "Artist", "Song")]
artist_counts <- aggregate(data.frame(count = raw_artist_data$Artist), list(value = raw_artist_data$Artist), length)


artist_ids <- total_df[, c("Artist", "ArtistID", "Song")]
artist_ids <- artist_ids[row.names(unique(artist_ids[, c("Artist", "ArtistID")])),]

names(artist_counts)[1] <- "Artist"
names(artist_counts)[2] <- "Songs"

# merge artist_ids with artist_counts
total_artists <- merge(x=artist_counts, y=artist_ids, by="Artist")
artist_counts <- total_artists[, c("Artist", "ArtistID", "Songs")]

artist_counts <- dplyr::arrange(artist_counts, desc(Songs))

reactable(artist_counts[1:25,],
          columns = list(
            Artist = colDef(cell = function(value) {
            image <- img(src = sprintf("artist_images/%s.jpg", value), height = "100px", alt = value)
            tagList(
            div(style = list(display = "inline-block", width = "100px"), image), value)
            }),
            ArtistID = colDef(align = "left",
            style = list(fontFamily = "monospace", whiteSpace = "pre"),
            cell = function(value) {
            url <- paste0("spotify:artist:", value)
            tags$a(href = url, target = "_blank", paste0(value))
            },header = with_tooltip("ID", "Click to open artist in Spotify")),
            Songs = colDef(cell = function(value){
                     width <- paste0(value / max(artist_counts$Songs) * 100, "%")
                     value <- format(value, width = 5, justify = "right")
                     bar_chart(value, width = width,
                               background = "#e1e1e1",
                               fill = "#DF1313")},
            style = list(fontFamily = "monospace", whiteSpace = "pre", fontSize = "14px"))),
          highlight = TRUE,
          sortable = FALSE,
          striped = TRUE,
          outlined = TRUE,
)
```

## User Contributions
```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
user_counts <- aggregate(data.frame(count = raw_artist_data$User), list(value = raw_artist_data$User), length)
names(user_counts)[1] <- "User"
names(user_counts)[2] <- "Songs"

user_counts <- dplyr::arrange(user_counts, desc(Songs))

reactable(user_counts,
          columns = list(
            Songs = colDef(cell = function(value){
                     width <- paste0(value / max(user_counts$Songs) * 100, "%")
                     value <- format(value, width = 5, justify = "right")
                     bar_chart(value, width = width,
                               background = "#e1e1e1",
                               fill = "#DF1313")},
          style = list(fontFamily = "monospace", whiteSpace = "pre", fontSize = "14px"),
          sortable = FALSE)),
          highlight = TRUE,
          sortable = FALSE,
          outlined = TRUE,
          striped = TRUE,
)
```
Vaultbot is maintained by <a class="navlink" href="https://tbrittain.com">Trey Brittain</a>.
