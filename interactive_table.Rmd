---
title: Vaultbot Playlist Stats
output:
  html_document:
    theme: darkly
    highlight: pygments
    self_contained: true
fig_width: 10 
fig_height: 4
---

<style>

@import url("https://fonts.googleapis.com/css?family=Rubik");
@import url("https://fonts.googleapis.com/css?family=Monofett");

* {
    font-family: Rubik, Arial, Helvetica, sans-serif;
}

::-moz-selection {
    background-color: #0CE3AC;
    color: black;
}

::selection {
    background-color: #0CE3AC;
    color: black;
}

html{
    min-height: 100%;
    scroll-behavior: smooth;
}
body .main-container {
    max-width: 4000px;
}

body {
    background-image: url('artist_images/background2.jpg');
    background-repeat: repeat;
    font-size: 16px;
    line-height: 24px;
    overflow: auto;
}

div {
  text-align: center;
}

h1,h2,h3,h4 {
    background-color: rgba(0, 0, 0, 0.75);
    font-weight: bold;
}

p {
    background-color: rgba(0, 0, 0, 0.75);
}

.container { width: 1000px; }
h3 {
  background-color: #D4DAEC;
  text-indent: 100px; 
}

h4 {
  text-indent: 100px;
}

.center {
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 40%;
}

.centersmall {
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 12%;
}

.bar-sort-header:hover {
  background-color: #373845;
}

/**
 * Navigation bar CSS
 */

ul {
  display: block;
  margin-left: auto;
  margin-right: auto;
  list-style-type: none;
  margin: 0;
  padding: 0;
  overflow: hidden;
  background-color: rgba(53, 53, 53, 0.9);
  position: fixed;
  top: 0;
  width: 100%;
  box-sizing: border-box;
  z-index: 10;
  border-radius: 10px;
  border: 2px solid #000;
  text-shadow: 1px 1px 1.5px #000;
}

li {
  float: left;
}

li a {
  display: block;
  color: white;
  text-align: center;
  padding: 10px 16px;
  text-decoration: none;
  transition: 0.3s;
}

li a:hover {
  background-color: #111;
  text-decoration: none;
  cursor: pointer;
  outline: 2px solid #FFF;
  outline-offset: 2px;
  font-size: 105%;
}

.active {
  background-color: #0CE3AC;
  padding: 10px 16px;
}

.title {
    visibility: hidden;
}


/*
Vaultbot title
*/

.vaultbot-title {
    font-family: Monofett, sans-serif;
    background-color: transparent;
    font-size: 8vw;
    max-width: 65%;
    text-align: center;
    margin: auto auto;
    overflow: hidden;
    text-overflow: ellipsis;
    word-wrap: normal;
    display: block;
}

.gradient-text {
    background-color: #0CE3AC;
    background-image: linear-gradient(to right, hsla(165, 90%, 47%, 1) 0%, hsla(103, 100%, 71%, 1) 50%, hsla(165, 90%, 47%, 1) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -moz-background-clip: text;

    text-fill-color: transparent;
    -webkit-text-fill-color: transparent;
    -moz-text-fill-color: transparent;

    transition: 0.2s ease-in-out;
    -moz-transition: 0.2s ease-in-out;
    -webkit-transition: 0.2s ease-in-out;
    animation: hoveranimation 5s linear infinite;
}

@keyframes hoveranimation {
	to {
		background-position: 200% center;
	}
}

.noselect {
  -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Old versions of Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome, Edge, Opera and Firefox */

</style>


```{r setup, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
library(rmarkdown)
library(reactable)
library(tibble)
library(htmltools)
library(dplyr)
library(RPostgres)
library(DBI)
```

```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
setwd("D:/Github/vault-bot/")
Sys.setenv(RSTUDIO_PANDOC="C:/Users/Trey/AppData/Local/Pandoc")
readRenviron(".env")
db_user <- Sys.getenv("DB_USER")
db_pass <- Sys.getenv("DB_PASS")
db <- 'vaultbot'
db_port <- 5432
db_host <- 'localhost'

con<-dbConnect(RPostgres::Postgres(), dbname=db, host=db_host, port=db_port, user=db_user, password=db_pass)

total_df <- RPostgres::dbReadTable(con, "dynamic")

# disconnect from db
RPostgres::dbDisconnect(con)
# rename columns
names(total_df)[1] <- "ID"
names(total_df)[2] <- "Artist"
names(total_df)[3] <- "Album"
names(total_df)[4] <- "User"
names(total_df)[5] <- "Date"
names(total_df)[6] <- "Length"
names(total_df)[7] <- "Tempo"
names(total_df)[8] <- "Danceability"
names(total_df)[9] <- "Energy"
names(total_df)[10] <- "Loudness"
names(total_df)[11] <- "Acousticness"
names(total_df)[12] <- "Instrumentalness"
names(total_df)[13] <- "Liveness"
names(total_df)[14] <- "Valence"
names(total_df)[15] <- "Tracks"
names(total_df)[16] <- "Popularity"

# variables for use in title
title_today <- format(Sys.time(), "%c")
song_count <- nrow(total_df)
plot_title <- sprintf("Overall view of every song present in the playlist (%d songs as of %s). Updates every hour!",
                      song_count, title_today)

# set reactable theme
options(reactable.theme = reactableTheme(
  color = "hsl(233, 9%, 87%)",
  backgroundColor = "hsl(233, 9%, 10%)",
  borderColor = "hsl(233, 9%, 0%)",
  stripedColor = "hsl(233, 12%, 13%)",
  highlightColor = "hsl(233, 12%, 24%)",
  inputStyle = list(backgroundColor = "hsl(233, 9%, 12%)"),
  selectStyle = list(backgroundColor = "hsl(233, 9%, 25%)"),
  pageButtonHoverStyle = list(backgroundColor = "hsl(233, 9%, 25%)"),
  pageButtonActiveStyle = list(backgroundColor = "hsl(233, 9%, 28%)"),
  searchInputStyle = list(width = "100%")
))

# copy data from original df
table_data <- total_df[, c("User", "Artist", "Album", "Tracks", "ID",
                           "Date", "Popularity","Length", "Tempo", "Danceability",
                           "Energy", "Loudness", "Valence")]

# round df values
table_data$Length <- round(table_data$Length, digits = 2)
table_data$Loudness <- ifelse(table_data$Loudness <= -10,
                              round(table_data$Loudness, digits = 1),
                              round(table_data$Loudness, digits = 2))
table_data$Tempo <- round(table_data$Tempo, digits = 1)
table_data$Danceability <- round(table_data$Danceability, digits = 3)
table_data$Energy <- round(table_data$Energy, digits = 3)
table_data$Valence <- round(table_data$Valence, digits = 3)

# bar chart function for use in reactable colDef function
bar_chart <- function(label, width = "100%", height = "16px", fill = "#00bfc4", background = NULL) {
  bar <- div(style = list(background = fill, width = width, height = height))
  chart <- div(style = list(flexGrow = 1, marginLeft = "8px", background = background), bar)
  div(style = list(display = "flex", alignItems = "center"), label, chart)
}
# tooltip function
with_tooltip <- function(value, tooltip) {
  tags$abbr(style = "text-decoration: underline; text-decoration-style: dotted; cursor: help",
            title = tooltip, value)
}
```
 <ul>
    <li><a class="active" href="index.html">Stats</a></li>
    <li><a href="advanced.html">Advanced Stats</a></li>
    <li><a href="highscores.html">Highscores</a></li>
    <li><a href="spotify:playlist:5YQHb5wt9d0hmShWNxjsTs">Dynamic Playlist</a></li>
    <li><a href="spotify:playlist:4C6pU7YmbBUG8sFFk4eSXj">Archive Playlist</a></li>
    <li style="float:right"><a href="https://tbrittain.com">Trey's homepage</a></li>
</ul>

<h1 class="vaultbot-title noselect gradient-text">Vaultbot</h1>

`r plot_title`


```{r, include=TRUE, echo=FALSE}
options(width = 2000)
reactable(
  table_data,
  columns = list(
    User = colDef(align = "left",
                  style = list(fontFamily = "monospace", whiteSpace = "pre"),
                  footer = "Average"),
    Artist = colDef(align = "left",
                    style = list(fontFamily = "Arial, Helvetica", whiteSpace = "pre")),
    Album = colDef(align = "left",
                    style = list(fontFamily = "Arial, Helvetica", whiteSpace = "pre")),
    Tracks = colDef(align = "left",
                    style = list(fontFamily = "Arial, Helvetica", whiteSpace = "pre")),
    ID = colDef(align = "left",
                style = list(fontFamily = "monospace", whiteSpace = "pre"),
                cell = function(value) {
                url <- paste0("spotify:track:", value)
                tags$a(href = url, target = "_blank", paste0(value))
                }, header = with_tooltip("ID", "Click to open track in Spotify")),
    Date = colDef(align = "left",
                  style = list(fontFamily = "monospace", whiteSpace = "pre")),
    Tracks = colDef(aggregate = "count",
                    align = "left",
                    style = list(fontFamily = "monospace", whiteSpace = "pre")),
    Popularity = colDef(aggregate = "mean",
                    align = "left",
                    filterable = FALSE,
                    cell = function(value){
                     width <- paste0(value / max(table_data$Popularity) * 100, "%")
                     value <- format(value, width = 5, justify = "right")
                     bar_chart(value, width = width,
                               background = "#2b2b2b",
                               fill = "#0CE3AC")
                  }, header = with_tooltip("Popularity", "Updates hourly"),
                    style = list(fontFamily = "monospace", whiteSpace = "pre"),
                    footer = JS("function(colInfo) {
                      var total = 0
                      var number_obsv = 0
                      colInfo.data.forEach(function(row) {
                      total += row[colInfo.column.id]
                      number_obsv += 1
                      })
                      var avg_value = total / number_obsv
                      return avg_value.toFixed(2)
                      }")),
    Length = colDef(aggregate = "mean",
                    align = "left",
                    filterable = FALSE,
                    cell = function(value){
                     width <- paste0(value / max(table_data$Length) * 100, "%")
                     value <- format(value, width = 5, justify = "right")
                     bar_chart(value, width = width,
                               background = "#2b2b2b",
                               fill = "#0CE3AC")
                  }, header = with_tooltip("Length", "Minutes in decimal form"),
                    style = list(fontFamily = "monospace", whiteSpace = "pre"),
                    footer = JS("function(colInfo) {
                      var total = 0
                      var number_obsv = 0
                      colInfo.data.forEach(function(row) {
                      total += row[colInfo.column.id]
                      number_obsv += 1
                      })
                      var avg_value = total / number_obsv
                      return avg_value.toFixed(2)
                      }")),
    Tempo = colDef(aggregate = "mean",
                   align = "left",
                   filterable = FALSE,
                   format = colFormat(digits = 1),
                   cell = function(value){
                     width <- paste0(value / max(table_data$Tempo) * 100, "%")
                     value <- format(value, width = 5, justify = "right")
                     bar_chart(value, width = width,
                               background = "#2b2b2b",
                               fill = "#0CE3AC")
                  },
                   header = with_tooltip("Tempo", "Take with a grain of salt"),
                   style = list(fontFamily = "monospace", whiteSpace = "pre"),
                   footer = JS("function(colInfo) {
                    var total = 0
                    var number_obsv = 0
                    colInfo.data.forEach(function(row) {
                    total += row[colInfo.column.id]
                    number_obsv += 1
                    })
                    var avg_value = total / number_obsv
                    return avg_value.toFixed(2)
                    }")),
    Danceability = colDef(aggregate = "mean",
                          align = "left",
                          format = colFormat(digits = 3),
                          filterable = FALSE,
                          cell = function(value){
                           width <- paste0(value / max(table_data$Danceability) * 100, "%")
                           value <- format(value, width = 5, justify = "right")
                           bar_chart(value, width = width,
                                            background = "#2b2b2b",
                                            fill = "#0CE3AC")
                          }, style = list(fontFamily = "monospace", whiteSpace = "pre"),
                          footer = JS("function(colInfo) {
                            var total = 0
                            var number_obsv = 0
                            colInfo.data.forEach(function(row) {
                            total += row[colInfo.column.id]
                            number_obsv += 1
                            })
                            var avg_value = total / number_obsv
                            return avg_value.toFixed(2)
                            }")),
    Energy = colDef(aggregate = "mean",
                    align = "left",
                    format = colFormat(digits = 3),
                    filterable = FALSE,
                    cell = function(value){
                     width <- paste0(value / max(table_data$Energy) * 100, "%")
                     value <- format(value, width = 5, justify = "right")
                     bar_chart(value, width = width,
                                      background = "#2b2b2b",
                                      fill = "#0CE3AC")
                  }, style = list(fontFamily = "monospace", whiteSpace = "pre"),
                    footer = JS("function(colInfo) {
                      var total = 0
                      var number_obsv = 0
                      colInfo.data.forEach(function(row) {
                      total += row[colInfo.column.id]
                      number_obsv += 1
                      })
                      var avg_value = total / number_obsv
                      return avg_value.toFixed(2)
                      }")),
    Loudness = colDef(aggregate = "mean",
                      align = "left",
                      format = colFormat(digits = 2),
                      filterable = FALSE,
                      cell = function(value){
                       width <- paste0(3/(value/median(table_data$Loudness)) * 15, "%")
                       value <- format(value, width = 5, justify = "right")
                       bar_chart(value, width = width,
                                        background = "#2b2b2b",
                                        fill = "#0CE3AC")
                  }, style = list(fontFamily = "monospace", whiteSpace = "pre"),
                      footer = JS("function(colInfo) {
                        var total = 0
                        var number_obsv = 0
                        colInfo.data.forEach(function(row) {
                        total += row[colInfo.column.id]
                        number_obsv += 1
                        })
                        var avg_value = total / number_obsv
                        return avg_value.toFixed(2)
                        }")),
    Valence = colDef(aggregate = "mean",
                     align = "left",
                     format = colFormat(digits = 3),
                     filterable = FALSE,
                     cell = function(value){
                       width <- paste0(value / max(table_data$Valence) * 100, "%")
                       value <- format(value, width = 5, justify = "right")
                       bar_chart(value, width = width,
                                 background = "#2b2b2b",
                                 fill = "#0CE3AC")
                  }, style = list(fontFamily = "monospace", whiteSpace = "pre"),
                      footer = JS("function(colInfo) {
                        var total = 0
                        var number_obsv = 0
                        colInfo.data.forEach(function(row) {
                        total += row[colInfo.column.id]
                        number_obsv += 1
                        })
                        var avg_value = total / number_obsv
                        return avg_value.toFixed(2)
                        }"))
  ),
  style = list(fontFamily = "monospace", whiteSpace = "pre", fontSize = "14px"),
  defaultSorted = list(Date = "desc"),
  defaultColDef = colDef(headerClass = "bar-sort-header"),
  highlight = TRUE,
  compact = TRUE,
  striped = TRUE,
  outlined = TRUE,
  searchable = TRUE,
  filterable = TRUE,
  wrap = FALSE,
  resizable = TRUE,
  showSortable = TRUE,
  defaultPageSize = 25,
  showPageSizeOptions = TRUE,
  pageSizeOptions = c(25, 50, 100, 200),
)

```
Vaultbot is maintained by <a class="navlink" href="https://tbrittain.com">Trey Brittain</a>.

