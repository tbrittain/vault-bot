---
title: Vaultbot Playlist Stats
output:
  html_document:
    theme: flatly
    highlight: pygments
    self_contained: true
assets:
  css:
    - "https://fonts.googleapis.com/css?family=Rubik"
fig_width: 10 
fig_height: 4 

---

<style>
html{
    min-height: 100%;
}
body .main-container {
    max-width: 4000px;
}
body {
    background: -webkit-linear-gradient(top, #FBFFF5, #C6DBF0); 
    background: -o-linear-gradient(top, #FBFFF5, #C6DBF0);
    background: -moz-linear-gradient(top, #FBFFF5, #C6DBF0); 
    background: linear-gradient(to bottom, #FBFFF5, #C6DBF0); 
    background-color: #FBFFF5; 
    font-family: 'Rubik', sans-serif;
    font-size: 16px;
    line-height: 24px;
}

div {
  text-align: center;
}


h1,h2,h3,h4 {
  font-family: 'Rubik', sans-serif;
}

.container { width: 1000px; }
h3 {
  background-color: #D4DAEC;
  text-indent: 100px; 
}

h4 {
  text-indent: 100px;
}

.center {
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 25%;
}

.bar-sort-header:hover {
  background-color: #eee;
}
</style>


```{r setup, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
library(rmarkdown)
library(reactable)
library(tibble)
library(htmltools)
library(dplyr)
library(RPostgres)
library(DBI)
```

```{r, include=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
setwd("D:/Github/vault-bot/")
Sys.setenv(RSTUDIO_PANDOC="C:/Users/Trey/AppData/Local/Pandoc")
readRenviron(".env")
db_user <- Sys.getenv("DB_USER")
db_pass <- Sys.getenv("DB_PASS")
db <- 'vaultbot'
db_port <- 5432
db_host <- 'localhost'

con<-dbConnect(RPostgres::Postgres(), dbname=db, host=db_host, port=db_port, user=db_user, password=db_pass)

total_df <- RPostgres::dbReadTable(con, "dynamic")

# disconnect from db
RPostgres::dbDisconnect(con)
# rename columns
names(total_df)[1] <- "ID"
names(total_df)[2] <- "Artist"
names(total_df)[3] <- "Album"
names(total_df)[4] <- "User"
names(total_df)[5] <- "Date"
names(total_df)[6] <- "Length"
names(total_df)[7] <- "Tempo"
names(total_df)[8] <- "Danceability"
names(total_df)[9] <- "Energy"
names(total_df)[10] <- "Loudness"
names(total_df)[11] <- "Acousticness"
names(total_df)[12] <- "Instrumentalness"
names(total_df)[13] <- "Liveness"
names(total_df)[14] <- "Valence"
names(total_df)[15] <- "Tracks"
names(total_df)[16] <- "Popularity"

# variables for use in title
title_today <- format(Sys.time(), "%c")
song_count <- nrow(total_df)
plot_title <- sprintf("Overall view of every song present in the playlist (%d songs as of %s). Updates every hour!",
                      song_count, title_today)

# set reactable theme here optionally


# copy data from original df
table_data <- total_df[, c("User", "Artist", "Album", "Tracks", "ID",
                           "Date", "Popularity","Length", "Tempo", "Danceability",
                           "Energy", "Loudness", "Valence")]

# round df values
table_data$Length <- round(table_data$Length, digits = 2)
table_data$Loudness <- ifelse(table_data$Loudness <= -10,
                              round(table_data$Loudness, digits = 1),
                              round(table_data$Loudness, digits = 2))
table_data$Tempo <- round(table_data$Tempo, digits = 1)
table_data$Danceability <- round(table_data$Danceability, digits = 3)
table_data$Energy <- round(table_data$Energy, digits = 3)
table_data$Valence <- round(table_data$Valence, digits = 3)

# bar chart function for use in reactable colDef function
bar_chart <- function(label, width = "100%", height = "16px", fill = "#00bfc4", background = NULL) {
  bar <- div(style = list(background = fill, width = width, height = height))
  chart <- div(style = list(flexGrow = 1, marginLeft = "8px", background = background), bar)
  div(style = list(display = "flex", alignItems = "center"), label, chart)
}
# tooltip function
with_tooltip <- function(value, tooltip) {
  tags$abbr(style = "text-decoration: underline; text-decoration-style: dotted; cursor: help",
            title = tooltip, value)
}
```

<img src="D:/Github/vault-bot/embeds/vaultbotheader.png" alt="Vaultbot Playlist Song Statistics" class="center">

`r plot_title`
To listen to the dynamic playlist, <a class="navlink" href="spotify:playlist:5YQHb5wt9d0hmShWNxjsTs">click here</a>.

**New**: To view highscores, <a class="navlink" href="http://vaultbot.tbrittain.com/highscores.html">click here</a>.


```{r, include=TRUE, echo=FALSE}
options(width = 2000)
reactable(
  table_data,
  columns = list(
    User = colDef(align = "left",
                  style = list(fontFamily = "monospace", whiteSpace = "pre"),
                  footer = "Average"),
    Artist = colDef(align = "left",
                    style = list(fontFamily = "monospace", whiteSpace = "pre")),
    Album = colDef(align = "left",
                    style = list(fontFamily = "monospace", whiteSpace = "pre")),
    Tracks = colDef(align = "left",
                    style = list(fontFamily = "monospace", whiteSpace = "pre")),
    ID = colDef(align = "left",
                style = list(fontFamily = "monospace", whiteSpace = "pre"),
                cell = function(value) {
                url <- paste0("spotify:track:", value)
                tags$a(href = url, target = "_blank", paste0(value))
                }, header = with_tooltip("ID", "Click to open track in Spotify")),
    Date = colDef(align = "left",
                  style = list(fontFamily = "monospace", whiteSpace = "pre")),
    Tracks = colDef(aggregate = "count",
                    align = "left",
                    style = list(fontFamily = "monospace", whiteSpace = "pre")),
    Popularity = colDef(aggregate = "mean",
                    align = "left",
                    filterable = FALSE,
                    cell = function(value){
                     width <- paste0(value / max(table_data$Popularity) * 100, "%")
                     value <- format(value, width = 5, justify = "right")
                     bar_chart(value, width = width,
                               background = "#e1e1e1",
                               fill = "#DF1313")
                  }, header = with_tooltip("Popularity", "Updates hourly"),
                    style = list(fontFamily = "monospace", whiteSpace = "pre"),
                    footer = JS("function(colInfo) {
                      var total = 0
                      var number_obsv = 0
                      colInfo.data.forEach(function(row) {
                      total += row[colInfo.column.id]
                      number_obsv += 1
                      })
                      var avg_value = total / number_obsv
                      return avg_value.toFixed(2)
                      }")),
    Length = colDef(aggregate = "mean",
                    align = "left",
                    filterable = FALSE,
                    cell = function(value){
                     width <- paste0(value / max(table_data$Length) * 100, "%")
                     value <- format(value, width = 5, justify = "right")
                     bar_chart(value, width = width,
                               background = "#e1e1e1",
                               fill = "#BD2637")
                  }, header = with_tooltip("Length", "Minutes in decimal form"),
                    style = list(fontFamily = "monospace", whiteSpace = "pre"),
                    footer = JS("function(colInfo) {
                      var total = 0
                      var number_obsv = 0
                      colInfo.data.forEach(function(row) {
                      total += row[colInfo.column.id]
                      number_obsv += 1
                      })
                      var avg_value = total / number_obsv
                      return avg_value.toFixed(2)
                      }")),
    Tempo = colDef(aggregate = "mean",
                   align = "left",
                   filterable = FALSE,
                   format = colFormat(digits = 1),
                   cell = function(value){
                     width <- paste0(value / max(table_data$Tempo) * 100, "%")
                     value <- format(value, width = 5, justify = "right")
                     bar_chart(value, width = width,
                               background = "#e1e1e1",
                               fill = "#9A395B")
                  },
                   header = with_tooltip("Tempo", "Take with a grain of salt"),
                   style = list(fontFamily = "monospace", whiteSpace = "pre"),
                   footer = JS("function(colInfo) {
                    var total = 0
                    var number_obsv = 0
                    colInfo.data.forEach(function(row) {
                    total += row[colInfo.column.id]
                    number_obsv += 1
                    })
                    var avg_value = total / number_obsv
                    return avg_value.toFixed(2)
                    }")),
    Danceability = colDef(aggregate = "mean",
                          align = "left",
                          format = colFormat(digits = 3),
                          filterable = FALSE,
                          cell = function(value){
                           width <- paste0(value / max(table_data$Danceability) * 100, "%")
                           value <- format(value, width = 5, justify = "right")
                           bar_chart(value, width = width,
                                            background = "#e1e1e1",
                                            fill = "#784C7F")
                          }, style = list(fontFamily = "monospace", whiteSpace = "pre"),
                          footer = JS("function(colInfo) {
                            var total = 0
                            var number_obsv = 0
                            colInfo.data.forEach(function(row) {
                            total += row[colInfo.column.id]
                            number_obsv += 1
                            })
                            var avg_value = total / number_obsv
                            return avg_value.toFixed(2)
                            }")),
    Energy = colDef(aggregate = "mean",
                    align = "left",
                    format = colFormat(digits = 3),
                    filterable = FALSE,
                    cell = function(value){
                     width <- paste0(value / max(table_data$Energy) * 100, "%")
                     value <- format(value, width = 5, justify = "right")
                     bar_chart(value, width = width,
                                      background = "#e1e1e1",
                                      fill = "#565FA2")
                  }, style = list(fontFamily = "monospace", whiteSpace = "pre"),
                    footer = JS("function(colInfo) {
                      var total = 0
                      var number_obsv = 0
                      colInfo.data.forEach(function(row) {
                      total += row[colInfo.column.id]
                      number_obsv += 1
                      })
                      var avg_value = total / number_obsv
                      return avg_value.toFixed(2)
                      }")),
    Loudness = colDef(aggregate = "mean",
                      align = "left",
                      format = colFormat(digits = 2),
                      filterable = FALSE,
                      cell = function(value){
                       width <- paste0(3/(value/median(table_data$Loudness)) * 15, "%")
                       value <- format(value, width = 5, justify = "right")
                       bar_chart(value, width = width,
                                        background = "#e1e1e1",
                                        fill = "#3372C6")
                  }, style = list(fontFamily = "monospace", whiteSpace = "pre"),
                      footer = JS("function(colInfo) {
                        var total = 0
                        var number_obsv = 0
                        colInfo.data.forEach(function(row) {
                        total += row[colInfo.column.id]
                        number_obsv += 1
                        })
                        var avg_value = total / number_obsv
                        return avg_value.toFixed(2)
                        }")),
    Valence = colDef(aggregate = "mean",
                     align = "left",
                     format = colFormat(digits = 3),
                     filterable = FALSE,
                     cell = function(value){
                       width <- paste0(value / max(table_data$Valence) * 100, "%")
                       value <- format(value, width = 5, justify = "right")
                       bar_chart(value, width = width,
                                 background = "#e1e1e1",
                                 fill = "#1185EA")
                  }, style = list(fontFamily = "monospace", whiteSpace = "pre"),
                      footer = JS("function(colInfo) {
                        var total = 0
                        var number_obsv = 0
                        colInfo.data.forEach(function(row) {
                        total += row[colInfo.column.id]
                        number_obsv += 1
                        })
                        var avg_value = total / number_obsv
                        return avg_value.toFixed(2)
                        }"))
  ),
  style = list(fontFamily = "monospace", whiteSpace = "pre", fontSize = "14px"),
  defaultSorted = list(Date = "desc"),
  defaultColDef = colDef(headerClass = "bar-sort-header"),
  highlight = TRUE,
  compact = TRUE,
  striped = TRUE,
  searchable = TRUE,
  filterable = TRUE,
  wrap = FALSE,
  resizable = TRUE,
  showSortable = TRUE,
  defaultPageSize = 25,
  showPageSizeOptions = TRUE,
  pageSizeOptions = c(25, 50, 100, 200),
  theme = reactableTheme(
    borderColor = "#000000",
    stripedColor = "#F6F6F6",
    highlightColor = "#CFE8EF",
    cellPadding = "8px 12px",
    style = list(fontFamily = "-apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif"),
    searchInputStyle = list(width = "100%")
  )
)

```
Vaultbot is maintained by <a class="navlink" href="https://tbrittain.com">Trey Brittain</a>.
